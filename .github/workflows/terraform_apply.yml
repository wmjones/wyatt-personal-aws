name: "Terraform Apply"

on:
    push:
      branches:
        - main
        - dev

env:
  TF_CLOUD_ORGANIZATION: "wyatt-personal-aws"
  TF_API_TOKEN: "${{ secrets.TF_API_TOKEN }}"
  TODOIST_API_SECRET: "${{ secrets.TODOIST_API_SECRET }}"
  NOTION_API_SECRET: "${{ secrets.NOTION_API_SECRET }}"
  TF_WORKSPACE: >-
    ${{
      github.ref == 'refs/heads/main' && 'wyatt-personal-aws-prod' ||
      'wyatt-personal-aws-dev'
    }}
  CONFIG_DIRECTORY: "./main"
  # New environment variable to track tfvars file path
  TFVARS_FILE: >-
    ${{
      github.ref == 'refs/heads/main' && './main/environments/prod.tfvars' ||
      './main/environments/dev.tfvars'
    }}

jobs:
  deployment_package_zip:
    uses: ./.github/workflows/deployment_package_zip.yml
  terraform:
    needs: deployment_package_zip
    name: "Terraform Apply"
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: deployment-package
          path: ./main/

      # New step to load variables from tfvars file into environment
      - name: Load TF Variables
        id: load_vars
        run: |
          # Read the tfvars file and convert to environment variables
          if [ -f "${{ env.TFVARS_FILE }}" ]; then
            echo "Loading variables from ${{ env.TFVARS_FILE }}"
            while IFS='=' read -r key value || [ -n "$key" ]; do
              # Skip comments and empty lines
              [[ $key =~ ^[[:space:]]*# ]] && continue
              [[ -z "$key" ]] && continue

              # Clean up the key and value
              key=$(echo $key | xargs)
              value=$(echo $value | xargs)

              # Remove any quotes from the value
              value="${value%\"}"
              value="${value#\"}"

              # Export as TF_VAR_ environment variable
              echo "TF_VAR_$key=$value" >> $GITHUB_ENV
              echo "Set TF_VAR_$key"
            done < "${{ env.TFVARS_FILE }}"
            echo "Variables loaded successfully"
          else
            echo "Warning: ${{ env.TFVARS_FILE }} not found"
          fi
        shell: bash

      - name: Upload Configuration
        uses: hashicorp/tfc-workflows-github/actions/upload-configuration@v1.0.0
        id: apply-upload
        with:
          workspace: ${{ env.TF_WORKSPACE }}
          directory: ${{ env.CONFIG_DIRECTORY }}

      - name: Create Apply Run
        uses: hashicorp/tfc-workflows-github/actions/create-run@v1.0.0
        id: apply-run
        with:
          workspace: ${{ env.TF_WORKSPACE }}
          configuration_version: ${{ steps.apply-upload.outputs.configuration_version_id }}
          # Environment variables are automatically passed to Terraform Cloud

      - name: Apply
        uses: hashicorp/tfc-workflows-github/actions/apply-run@v1.0.0
        if: fromJSON(steps.apply-run.outputs.payload).data.attributes.actions.IsConfirmable
        id: apply
        with:
          run: ${{ steps.apply-run.outputs.run_id }}
          comment: "Apply Run from GitHub Actions CI ${{ github.sha }}"
