<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>D3 Dashboard - Demo</title>
    <meta name="description" content="D3 Dashboard Functionality Demo" />
    <link rel="stylesheet" href="/styles.css" />
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
      .chart-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-top: 20px;
      }

      .controls {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 20px;
        justify-content: center;
      }

      .control-group {
        display: flex;
        flex-direction: column;
        min-width: 200px;
      }

      label {
        margin-bottom: 5px;
        font-weight: 500;
      }

      input[type="number"], select {
        padding: 8px;
        border: 1px solid var(--light-gray);
        border-radius: 4px;
      }

      button {
        background-color: var(--primary-color);
        color: white;
        border: none;
        border-radius: 4px;
        padding: 10px 15px;
        cursor: pointer;
        font-weight: 500;
        transition: background-color 0.2s;
      }

      button:hover {
        background-color: var(--primary-dark);
      }

      .connection-status {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
      }

      .ws-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
      }

      .ws-connected {
        background-color: var(--success-color);
      }

      .ws-disconnected {
        background-color: var(--error-color);
      }

      .ws-connecting {
        background-color: var(--warning-color);
      }

      #log-container {
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid var(--light-gray);
        padding: 10px;
        border-radius: 4px;
        font-family: monospace;
        background-color: #f8f8f8;
        margin-top: 20px;
      }

      .log-entry {
        margin-bottom: 5px;
        padding: 3px 0;
        border-bottom: 1px solid #eee;
      }

      .log-time {
        color: #888;
        margin-right: 8px;
      }

      .log-info {
        color: var(--primary-color);
      }

      .log-error {
        color: var(--error-color);
      }

      .log-success {
        color: var(--success-color);
      }

      .updated-by {
        font-style: italic;
        color: #666;
        font-size: 0.9em;
        margin-top: 5px;
      }

      .chart svg {
        background-color: white;
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }

      .nav-links {
        text-align: center;
        margin-bottom: 20px;
      }

      .nav-links a {
        margin: 0 10px;
        color: var(--primary-color);
        text-decoration: none;
      }

      .nav-links a:hover {
        text-decoration: underline;
      }

      .db-status {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 20px;
      }

      .db-table {
        flex: 1;
        min-width: 250px;
        border: 1px solid var(--light-gray);
        border-radius: 4px;
        padding: 10px;
      }

      .db-table h4 {
        color: var(--primary-dark);
        margin-bottom: 10px;
        border-bottom: 1px solid var(--light-gray);
        padding-bottom: 5px;
      }

      .history-item {
        border-bottom: 1px dashed #eee;
        padding: 5px 0;
        font-size: 0.9em;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>D3 Dashboard - Demo</h1>
        <p>Test the new DynamoDB and WebSocket infrastructure</p>
        <div class="nav-links">
          <a href="index.html">Home</a>
          <a href="demo.html" class="active">Demo</a>
        </div>
      </header>

      <main>
        <section class="visualizer">
          <h2>Normal Distribution Visualizer</h2>

          <div class="connection-status">
            <div id="ws-status" class="ws-indicator ws-disconnected"></div>
            <span id="ws-status-text">Disconnected</span>
          </div>

          <div class="controls">
            <div class="control-group">
              <label for="mean">Mean (μ)</label>
              <input type="number" id="mean" value="0" step="0.1">
            </div>

            <div class="control-group">
              <label for="stdDev">Standard Deviation (σ)</label>
              <input type="number" id="stdDev" value="1" min="0.1" step="0.1">
            </div>

            <div class="control-group">
              <label for="user-id">User ID</label>
              <input type="text" id="user-id" value="demo-user">
            </div>

            <div class="control-group">
              <label for="param-id">Parameter ID</label>
              <input type="text" id="param-id" value="normal_distribution_params">
            </div>

            <div class="control-group">
              <label>&nbsp;</label>
              <button id="update-btn">Update Parameters</button>
            </div>

            <div class="control-group">
              <label>&nbsp;</label>
              <button id="connect-btn">Connect WebSocket</button>
            </div>
          </div>

          <div class="chart-container">
            <div id="chart" class="chart"></div>
            <p id="updated-by" class="updated-by">No updates yet</p>
          </div>

          <div class="db-status">
            <div class="db-table">
              <h4>Parameter Table</h4>
              <div id="parameter-status">Not fetched yet</div>
            </div>

            <div class="db-table">
              <h4>History Table</h4>
              <div id="history-status">Not fetched yet</div>
            </div>

            <div class="db-table">
              <h4>Connection Table</h4>
              <div id="connection-status">Not fetched yet</div>
            </div>
          </div>

          <div id="log-container">
            <div class="log-entry">
              <span class="log-time">[00:00:00]</span>
              <span class="log-info">Demo page loaded. Use the controls above to test functionality.</span>
            </div>
          </div>
        </section>
      </main>

      <footer>
        <p>D3 Dashboard - Demo for DynamoDB and WebSocket functionality</p>
      </footer>
    </div>

    <script>
      // Configuration
      let apiEndpoint = ''; // Will be populated from window location
      let wsEndpoint = '';  // Will be populated from window location

      // State variables
      let webSocket = null;
      let currentMean = 0;
      let currentStdDev = 1;
      let lastUpdatedBy = 'System';
      let connectionId = null;

      // DOM elements
      const wsStatus = document.getElementById('ws-status');
      const wsStatusText = document.getElementById('ws-status-text');
      const meanInput = document.getElementById('mean');
      const stdDevInput = document.getElementById('stdDev');
      const userIdInput = document.getElementById('user-id');
      const paramIdInput = document.getElementById('param-id');
      const updateBtn = document.getElementById('update-btn');
      const connectBtn = document.getElementById('connect-btn');
      const updatedByText = document.getElementById('updated-by');
      const logContainer = document.getElementById('log-container');
      const parameterStatus = document.getElementById('parameter-status');
      const historyStatus = document.getElementById('history-status');
      const connectionStatus = document.getElementById('connection-status');

      // Initialize the demo when page loads
      document.addEventListener('DOMContentLoaded', initDemo);

      function initDemo() {
        // Derive API and WebSocket endpoints from the current URL
        const hostParts = window.location.host.split('.');

        if (hostParts[0].includes('-dev') || hostParts[0].includes('-prod')) {
          // This is a deployed environment
          const env = hostParts[0].includes('-dev') ? 'dev' : 'prod';
          const region = hostParts[2] || 'us-east-1'; // Default to us-east-1 if region not in host

          // API Gateway endpoint for HTTP API
          apiEndpoint = `https://api-${env}.${hostParts.slice(1).join('.')}`;

          // WebSocket endpoint
          wsEndpoint = `wss://ws-${env}.${region}.amazonaws.com/${env}`;

          log('Detected deployed environment: ' + env);
          log('API Endpoint: ' + apiEndpoint);
          log('WebSocket Endpoint: ' + wsEndpoint);
        } else {
          // Local development - use example endpoints
          apiEndpoint = 'https://api-dev.example.com';
          wsEndpoint = 'wss://ws-dev.us-east-1.amazonaws.com/dev';
          log('Using example endpoints for local testing');
        }

        // Set up event listeners
        updateBtn.addEventListener('click', updateParameters);
        connectBtn.addEventListener('click', toggleWebSocketConnection);

        // Initialize the visualization
        initVisualization();

        // Fetch initial parameters
        fetchParameters();
      }

      function log(message, type = 'info') {
        const now = new Date();
        const timeString = now.toTimeString().split(' ')[0];

        const logEntry = document.createElement('div');
        logEntry.className = 'log-entry';

        const timeSpan = document.createElement('span');
        timeSpan.className = 'log-time';
        timeSpan.textContent = `[${timeString}]`;

        const messageSpan = document.createElement('span');
        messageSpan.className = `log-${type}`;
        messageSpan.textContent = message;

        logEntry.appendChild(timeSpan);
        logEntry.appendChild(document.createTextNode(' '));
        logEntry.appendChild(messageSpan);

        logContainer.appendChild(logEntry);
        logContainer.scrollTop = logContainer.scrollHeight;
      }

      function initVisualization() {
        // Set up D3.js visualization
        const margin = {top: 20, right: 30, bottom: 30, left: 40};
        const width = 600 - margin.left - margin.right;
        const height = 300 - margin.top - margin.bottom;

        // Remove any existing SVG
        d3.select("#chart").selectAll("*").remove();

        // Create SVG
        const svg = d3.select("#chart")
          .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
          .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        // X axis
        const x = d3.scaleLinear()
          .domain([-5, 5])
          .range([0, width]);

        svg.append("g")
          .attr("transform", `translate(0,${height})`)
          .call(d3.axisBottom(x));

        // Y axis
        const y = d3.scaleLinear()
          .domain([0, 0.5])
          .range([height, 0]);

        svg.append("g")
          .call(d3.axisLeft(y));

        // Function to calculate normal distribution PDF
        function normalPDF(x, mean, stdDev) {
          return (1 / (stdDev * Math.sqrt(2 * Math.PI))) *
                 Math.exp(-0.5 * Math.pow((x - mean) / stdDev, 2));
        }

        // Generate data points
        function generateDistributionData(mean, stdDev) {
          const data = [];
          for (let x = -5; x <= 5; x += 0.1) {
            data.push({
              x: x,
              y: normalPDF(x, mean, stdDev)
            });
          }
          return data;
        }

        // Draw the distribution curve
        const line = d3.line()
          .x(d => x(d.x))
          .y(d => y(d.y))
          .curve(d3.curveBasis);

        // Add the path with a unique ID
        svg.append("path")
          .datum(generateDistributionData(currentMean, currentStdDev))
          .attr("id", "distribution-curve")
          .attr("fill", "none")
          .attr("stroke", "#3b82f6")
          .attr("stroke-width", 2)
          .attr("d", line);

        // Add labels
        svg.append("text")
          .attr("id", "mean-label")
          .attr("text-anchor", "middle")
          .attr("x", x(currentMean))
          .attr("y", height + margin.bottom - 5)
          .style("font-size", "12px")
          .style("fill", "#3b82f6")
          .text(`μ = ${currentMean.toFixed(1)}`);

        // Add a vertical line at the mean
        svg.append("line")
          .attr("id", "mean-line")
          .attr("x1", x(currentMean))
          .attr("x2", x(currentMean))
          .attr("y1", 0)
          .attr("y2", height)
          .attr("stroke", "#3b82f6")
          .attr("stroke-width", 1)
          .attr("stroke-dasharray", "5,5");

        log('Visualization initialized with default parameters', 'success');
      }

      function updateVisualization(mean, stdDev, updatedBy) {
        // Update state
        currentMean = mean;
        currentStdDev = stdDev;
        lastUpdatedBy = updatedBy || lastUpdatedBy;

        // Update inputs if they don't match
        if (parseFloat(meanInput.value) !== mean) {
          meanInput.value = mean;
        }
        if (parseFloat(stdDevInput.value) !== stdDev) {
          stdDevInput.value = stdDev;
        }

        // Function to calculate normal distribution PDF
        function normalPDF(x, mean, stdDev) {
          return (1 / (stdDev * Math.sqrt(2 * Math.PI))) *
                 Math.exp(-0.5 * Math.pow((x - mean) / stdDev, 2));
        }

        // Generate data points
        function generateDistributionData(mean, stdDev) {
          const data = [];
          for (let x = -5; x <= 5; x += 0.1) {
            data.push({
              x: x,
              y: normalPDF(x, mean, stdDev)
            });
          }
          return data;
        }

        // Get D3 scales
        const svg = d3.select("#chart svg g");
        const width = svg.node().getBoundingClientRect().width;
        const height = svg.node().getBoundingClientRect().height;

        const x = d3.scaleLinear()
          .domain([-5, 5])
          .range([0, width - 80]); // Adjust for margins

        const y = d3.scaleLinear()
          .domain([0, 0.5])
          .range([height - 50, 0]); // Adjust for margins

        // Update the line
        const line = d3.line()
          .x(d => x(d.x))
          .y(d => y(d.y))
          .curve(d3.curveBasis);

        d3.select("#distribution-curve")
          .datum(generateDistributionData(mean, stdDev))
          .transition()
          .duration(500)
          .attr("d", line);

        // Update the mean label
        d3.select("#mean-label")
          .transition()
          .duration(500)
          .attr("x", x(mean))
          .text(`μ = ${mean.toFixed(1)}, σ = ${stdDev.toFixed(1)}`);

        // Update the mean line
        d3.select("#mean-line")
          .transition()
          .duration(500)
          .attr("x1", x(mean))
          .attr("x2", x(mean));

        // Update "updated by" text
        updatedByText.textContent = `Last updated by: ${lastUpdatedBy}`;

        log(`Visualization updated: mean = ${mean}, stdDev = ${stdDev}`, 'success');
      }

      async function fetchParameters() {
        try {
          // In a real implementation, this would use the API Gateway endpoint
          // For this demo, we'll simulate a response
          const userId = userIdInput.value;
          const paramId = paramIdInput.value;

          log(`Fetching parameters for user ${userId}, parameter ${paramId}...`);

          // Simulate API call delay
          await new Promise(resolve => setTimeout(resolve, 1000));

          // Simulate response data
          const responseData = {
            mean: 0,
            stdDev: 1,
            lastUpdatedBy: 'System (Demo)',
            lastUpdatedAt: Date.now(),
            paramId: paramId,
            userId: userId,
            version: 'v1'
          };

          // Update the visualization with fetched parameters
          updateVisualization(responseData.mean, responseData.stdDev, responseData.lastUpdatedBy);

          // Update parameter status display
          parameterStatus.innerHTML = `
            <div>Parameter ID: ${responseData.paramId}</div>
            <div>Mean: ${responseData.mean}</div>
            <div>StdDev: ${responseData.stdDev}</div>
            <div>Last Updated: ${new Date(responseData.lastUpdatedAt).toLocaleString()}</div>
            <div>Version: ${responseData.version}</div>
          `;

          // Also simulate history data
          historyStatus.innerHTML = `
            <div class="history-item">
              <div>Parameter: mean</div>
              <div>Changed from 0 to 0</div>
              <div>Time: ${new Date().toLocaleString()}</div>
              <div>By: System (Demo)</div>
            </div>
          `;

          log('Parameters fetched successfully', 'success');
          return responseData;
        } catch (error) {
          log(`Error fetching parameters: ${error.message}`, 'error');
          return { mean: 0, stdDev: 1, lastUpdatedBy: 'System' };
        }
      }

      async function updateParameters() {
        try {
          const mean = parseFloat(meanInput.value);
          const stdDev = parseFloat(stdDevInput.value);
          const userId = userIdInput.value;
          const paramId = paramIdInput.value;

          // Validate inputs
          if (isNaN(mean) || isNaN(stdDev)) {
            log('Invalid parameters. Please enter numeric values.', 'error');
            return;
          }

          if (stdDev <= 0) {
            log('Standard deviation must be positive.', 'error');
            return;
          }

          log(`Updating parameters: mean = ${mean}, stdDev = ${stdDev}, userId = ${userId}`);

          // In a real implementation, this would make an API call
          // For this demo, we'll simulate it

          // Simulate API call delay
          await new Promise(resolve => setTimeout(resolve, 1000));

          // Update the visualization
          updateVisualization(mean, stdDev, `${userId} (Demo)`);

          // Update parameter status
          const timestamp = Date.now();
          const version = 'v' + (parseInt((Math.random() * 5) + 1));

          parameterStatus.innerHTML = `
            <div>Parameter ID: ${paramId}</div>
            <div>Mean: ${mean}</div>
            <div>StdDev: ${stdDev}</div>
            <div>Last Updated: ${new Date(timestamp).toLocaleString()}</div>
            <div>Version: ${version}</div>
          `;

          // Add history entry
          const historyEntry = document.createElement('div');
          historyEntry.className = 'history-item';
          historyEntry.innerHTML = `
            <div>Parameter: ${Math.random() > 0.5 ? 'mean' : 'stdDev'}</div>
            <div>Changed from ${(Math.random() * 2).toFixed(1)} to ${(Math.random() * 2).toFixed(1)}</div>
            <div>Time: ${new Date().toLocaleString()}</div>
            <div>By: ${userId} (Demo)</div>
          `;

          historyStatus.prepend(historyEntry);

          log('Parameters updated successfully', 'success');
        } catch (error) {
          log(`Error updating parameters: ${error.message}`, 'error');
        }
      }

      function toggleWebSocketConnection() {
        if (webSocket && (webSocket.readyState === WebSocket.OPEN || webSocket.readyState === WebSocket.CONNECTING)) {
          // Disconnect
          webSocket.close();
          connectBtn.textContent = 'Connect WebSocket';
          log('WebSocket disconnected', 'info');
        } else {
          // Connect
          connectWebSocket();
          connectBtn.textContent = 'Disconnect WebSocket';
        }
      }

      function connectWebSocket() {
        // In a real implementation, use the actual WebSocket endpoint
        // For this demo, we'll simulate WebSocket behavior

        // Update UI to connecting state
        wsStatus.className = 'ws-indicator ws-connecting';
        wsStatusText.textContent = 'Connecting...';
        log('Connecting to WebSocket...', 'info');

        // Simulate connection delay
        setTimeout(() => {
          // Simulate successful connection
          wsStatus.className = 'ws-indicator ws-connected';
          wsStatusText.textContent = 'Connected';

          // Generate a fake connection ID
          connectionId = 'demo-conn-' + Math.random().toString(36).substring(2, 10);

          // Update connection status
          connectionStatus.innerHTML = `
            <div>Connection ID: ${connectionId}</div>
            <div>User ID: ${userIdInput.value}</div>
            <div>Connected At: ${new Date().toLocaleString()}</div>
            <div>TTL: ${new Date(Date.now() + 86400000).toLocaleString()}</div>
          `;

          log(`WebSocket connected. Connection ID: ${connectionId}`, 'success');

          // Simulate parameter updates from other users occasionally
          simulateUpdates();
        }, 1500);
      }

      function simulateUpdates() {
        // Only simulate if connected
        if (wsStatus.className.includes('connected')) {
          setTimeout(() => {
            // Random chance of update
            if (Math.random() > 0.7) {
              // Simulate receiving a message
              const randomMean = parseFloat((Math.random() * 4 - 2).toFixed(1));
              const randomStdDev = parseFloat((Math.random() * 1.5 + 0.5).toFixed(1));
              const randomUser = 'user-' + Math.floor(Math.random() * 1000);

              log(`Received parameter update from ${randomUser}`, 'info');
              updateVisualization(randomMean, randomStdDev, `${randomUser} (Demo)`);

              // Update parameter status
              const timestamp = Date.now();
              const version = 'v' + (parseInt((Math.random() * 5) + 1));

              parameterStatus.innerHTML = `
                <div>Parameter ID: ${paramIdInput.value}</div>
                <div>Mean: ${randomMean}</div>
                <div>StdDev: ${randomStdDev}</div>
                <div>Last Updated: ${new Date(timestamp).toLocaleString()}</div>
                <div>Version: ${version}</div>
              `;

              // Add history entry
              const historyEntry = document.createElement('div');
              historyEntry.className = 'history-item';
              historyEntry.innerHTML = `
                <div>Parameter: ${Math.random() > 0.5 ? 'mean' : 'stdDev'}</div>
                <div>Changed from ${(Math.random() * 2).toFixed(1)} to ${(Math.random() * 2).toFixed(1)}</div>
                <div>Time: ${new Date().toLocaleString()}</div>
                <div>By: ${randomUser} (Demo)</div>
              `;

              historyStatus.prepend(historyEntry);
            }

            // Continue simulation if still connected
            if (wsStatus.className.includes('connected')) {
              simulateUpdates();
            }
          }, 5000 + Math.random() * 10000); // Random interval between 5-15 seconds
        }
      }
    </script>
  </body>
</html>
